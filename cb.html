<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
! MPL 2.0 HEADER START
!
! This Source Code Form is subject to the terms of the Mozilla Public
! License, v. 2.0. If a copy of the MPL was not distributed with this
! file, You can obtain one at http://mozilla.org/MPL/2.0/.
!
! If applicable, add the following below this MPL 2.0 HEADER, replacing
! the fields enclosed by brackets "[]" replaced with your own identifying
! information:
!     Portions Copyright [yyyy] [name of copyright owner]
!
! MPL 2.0 HEADER END
!
!     Copyright 2013 ForgeRock AS
!
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>OpenID Connect Basic Client Profile</title>
    <script type="text/javascript"
            src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="basic.js"></script>
    <script type="text/javascript">

// When using response_type=code%20token, actually what comes back is a code
// and access token in the fragment, e.g.
// #code=4dee1d94-6aff-4cd7-8838-2fe0de677ec1&access_token=7121305b-732c-43af-8e5b-f740f6577a34&expires_in=59&token_type=Bearer&state=af0ifjsldkj

// So all this getting the access_token does not need to be done that way.
// Maybe not the basic profile, but it might work... TODO...

        $(document).ready(function () {
            var code = getParameterByName("code");
            var state = getParameterByName("state");
            if (code != "" && state != "") {
                $("#code").html("<h3>Authorization Code</h3>"
                        + "<p>Code: <code>" + code + "</code></p>"
                        + "<p>State: <code>" + state + "</code></p>");
            } else {
                $("#info").html(
                        "<p>Error obtaining authorization code:</p>"
                                + "<pre>"
                                + JSON.stringify(data, undefined, 2)
                                + "</pre>"
                );
                return;
            }

            // Use authorization code to retrieve access token.
            var access_token = getParameterByName("");
            $.ajax({
                url: server + openam + access,
                type: "POST",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization",
                            authHeader(client_id, client_secret));
                },
                data: {
                    "grant_type": "authorization_code",
                    "code": code,
                    "redirect_uri": redirect_uri
                },
                accepts: "json"
            }).done(function (data) {
                        $("#token").html(
                                "<h3>Access Token</h3>"
                                        + "<pre>"
                                        + JSON.stringify(data, undefined, 2)
                                        + "</pre>"
                        );

                        // TODO: validate the ID Token?

                        // Use the access token to get token information.
                        var access_token = data.access_token.toString();
                        $.getJSON({
                            url: server + openam + info,
                            data: {
                                "access_token" : access_token,
                                "scope": "openid profile" // not really sure what
                            }
                        }).done(function (data) {
                                    $("#info").html(
                                            "<h3>Token Info</h3>"
                                                    + "<pre>"
                                                    + JSON.stringify(
                                                        data, undefined, 2)
                                                    + "</pre>"
                                    );
                                }).fail(function (data) {
                                    $("#info").html(
                                            "<p>Error obtaining token info:</p>"
                                                    + "<pre>"
                                                    + JSON.stringify(
                                                        data, undefined, 2)
                                                    + "</pre>"
                                    );
                                });
                    }).fail(function (data) {
                        $("#info").html(
                                "<p>Error obtaining access token:</p>"
                                        + "<pre>"
                                        + JSON.stringify(data, undefined, 2)
                                        + "</pre>"
                        );
                    });
        });
    </script>
</head>
<body>

<div id="code"><!-- code goes here --></div>

<div id="token"><!-- token goes here --></div>

<div id="info"><!-- info goes here --></div>

<div><hr>Back to the <a href="index.html">start page</a></div>
</body>
</html>